SELECT 
	AVG(media_usuario) AS media_final,
	CONCAT('Los clientes se registran a un nodo diferente cada ',RTRIM(CAST(ROUND(AVG(CAST(media_usuario AS FLOAT)),2) AS CHAR)),' de media.') AS texto
FROM(
		SELECT 
			customer_id, 
			AVG(CAST(DATEDIFF(DAY,start_date,end_date)AS FLOAT)+1) AS media_usuario
		FROM (
				SELECT 
					customer_id,
					region_id,
					node_id,
					start_date,
					CASE 
						WHEN  (LAG(node_id,1,0) OVER (PARTITION BY customer_id ORDER BY start_date DESC))=node_id THEN CAST((LAG(REPLACE(RTRIM(CAST(end_date AS CHAR)),'-',''),1,0) OVER (PARTITION BY customer_id ORDER BY start_date DESC)) AS DATE) --Colocar fecha final correcta en el registro
						ELSE end_date 
					END AS end_date,
					CASE 
						WHEN (LAG(node_id,1,0) OVER (PARTITION BY customer_id ORDER BY start_date))=node_id  THEN 1 --Quitar valores sobrantes
						ELSE 0 
					END AS F2
				FROM(
						SELECT *,
							CASE 
								WHEN (LAG(node_id,1,0) OVER (PARTITION BY customer_id ORDER BY start_date))=node_id AND (LAG(node_id,1,0) OVER (PARTITION BY customer_id ORDER BY start_date desc))=node_id THEN 1 --Para quitar los registros que tenemos en el centro y quedarnos solo con el registro que tiene fecha inico y fecha fin
								ELSE 0 
							END AS F1
						FROM case03.customer_nodes
					) A
				WHERE F1=0 
			) B
		WHERE 
			F2=0 
			AND SUBSTRING(CAST(end_date AS CHAR),1,4)!='9999'
		GROUP BY CUSTOMER_ID
	) C
/**No me sale el mismo resultado :'(**/